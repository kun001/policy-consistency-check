# 前端：政策文件上传与结构化提取完整流程

本文档说明 React 前端从文件上传、内容识别，到后端结构化提取与条款展示的完整实现逻辑与交互流程。

## 总览

- 技术栈：React 18 + Vite 5 + Ant Design 5
- 主要组件与文件：
  - `src/components/LocalPolicyUpload.jsx`：上传与解析入口，承载整条流程
  - `src/components/TocViewer.jsx`：目录树展示（章节/节/条）
  - `src/api/textinApi.js`：TextIn 文档识别 API 封装（将 PDF/图片识别为 Markdown/JSON）
  - `src/api/backendApi.js`：Python 后端结构化提取 API 封装（`/extract-segments`）
  - `vite.config.js`：开发代理，将 `/api` 代理至后端，避免 CORS

## 交互流程

1. 文件上传
   - 用户通过 `Upload.Dragger` 选择本地文件（支持 `.pdf/.png/.jpg/.jpeg/.bmp/.tiff`）。
   - `beforeUpload` 返回 `false`，阻止自动上传，文件暂存到组件状态 `file`。

2. 文件内容识别（TextIn）
   - 点击“解析文件”按钮后执行 `handleParse()`。
   - 调用 `recognizeDocument(file, options, defaultCredentials)`：
     - 将二进制文件发送至 TextIn 服务，返回字符串形式的 JSON。
     - 使用 `extractMarkdown(resText)` 提取识别得到的 Markdown（若存在）。
   - 识别结果展示：
     - Markdown 以预览卡片形式展示，可折叠/展开。
     - 原始 JSON 响应可下载（`textin.json`）。

3. 文件结构化提取（Python 后端）
   - 在识别成功后，立即调用后端结构化接口：`extractSegments(file, false)`。
   - 接口路径：`POST /extract-segments`（通过 Vite 代理 `/api/extract-segments` 调用）。
   - 后端响应结构（示例）：
     ```json
     {
       "success": true,
       "file": { "name": "示例.pdf" },
       "toc": { "id": "doc-1", "type": "document", "children": [ /* 章节/节/条 */ ] },
       "counts": { "chapters": 2, "sections": 1, "articles": 6 }
     }
     ```
   - 前端将响应对象存入 `structured` 状态，并支持“下载结构化JSON”。

4. 目录树与条款展示
   - 使用 `TocViewer` 将 `structured.toc` 渲染为目录树（AntD `Tree`）。
   - 节点类型：
     - `document`（根）
     - `chapter`（章）
     - `section`（节）
     - `article`（条）
   - 点击目录中某条款节点，触发回调 `onSelectArticle(node, text)`，在右侧“条款详情”卡片中展示正文（含条款标签）。

## 关键实现细节

- 识别与结构化分步执行但串行衔接：
  - 识别完成后即刻发起结构化提取，用户无需多次点击。
  - 两步任一步出错都会提示错误信息（`message.error`）。

- Vite 开发代理（避免 CORS）：
  - 在 `vite.config.js` 中加入：
    ```js
    server: {
      proxy: {
        '/api': { target: 'http://localhost:10010', changeOrigin: true, secure: false }
      }
    }
    ```
  - 前端统一通过 `/api/extract-segments` 访问后端。

- 组件状态管理：
  - `file`：当前选择的文件对象
  - `responseText`：TextIn 原始响应字符串（可下载）
  - `markdown`：识别后的 Markdown 文本（预览）
  - `structured`：后端结构化响应对象（目录树 + 计数）
  - `selectedArticle`：当前选中的条款正文

- 目录树渲染逻辑：
  - 将后端 `toc.children` 映射为 AntD `Tree` 数据结构。
  - 对于 `article` 节点，只在树中展示 `label`（如“第一条”），正文在详情区展示。

## 常见问题与排查

1. 无法调用后端（网络错误/跨域）：
   - 确认后端 FastAPI 已在 `http://localhost:10010` 运行。
   - 确保 `vite.config.js` 包含 `/api` 代理并且前端使用 `/api/extract-segments`。
   - 若生产环境不使用代理，应在后端开启 CORS 或通过网关反向代理。

2. 识别失败或返回无 `markdown`：
   - TextIn 授权信息是否正确，参数是否有效。
   - 前端已做兼容：识别成功但无 `markdown` 会提示信息，并继续进行结构化提取。

3. 结构化提取失败：
   - 后端日志可查看具体错误（500/422），检查文件类型是否在允许范围内。
   - 若仅需结构化提取，可直接点击解析按钮触发（不强依赖 Markdown）。

## 后续扩展建议

- 目录树增强：支持关键字高亮、搜索条款、展开/收起控制。
- 条款详情：支持复制、导出单条款、跳转原文位置。
- 流程控制：增加“仅结构化提取”按钮，便于绕过外部识别服务。
- 类型安全：迁移至 TypeScript，定义 TOC 类型与接口响应类型。

---

如需对页面样式或交互做更深定制，可在 `TocViewer.jsx` 与 `LocalPolicyUpload.jsx` 中扩展配置与渲染逻辑。